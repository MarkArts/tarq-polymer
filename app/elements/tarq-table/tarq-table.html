<link rel='import' href='../../bower_components/polymer/polymer.html'>

<dom-module id='tarq-table'>

  <template>

    <table>
      <thead>
        <tr>
          <template is='dom-repeat' items='{{_columns}}' as='column'>
            <td on-click="_theadClick">{{column}}</td>
          </template>
        </tr>
      </thead>

      <tbody>
        <template id="rows" is='dom-repeat' items='{{_rows}}' as='row' filter="_filter", sort="_sort" >
          <tr>
            <template is='dom-repeat' items='{{_columns}}' as='column'>
              <td>{{_getColumnFrom(column, row)}}</td>
            </template>
          </tr>
        </template>
      </tbody>
    </table>

   <style>
      :host {
        display: block;
      }

      table {
        padding: 8px 0;
        border-collapse: collapse;
        width: 100%; }
        table  thead tr th, table  tfooter tr td {
          line-height: 56px; }
        table tbody tr td {
          line-height: 48px; }
        table thead th {
          font-size: 12px;
          color: #6E6E6E;
          font-weight: 500; }
        table tr {
          vertical-align: middle;
          text-align: left;
          border-bottom: 1px solid #ddd; }
        table td {
          font-size: 13px;
          color: #1F1F1F;
          font-weight: 400; }
        table th, table  td {
          padding-left: 24px;
          padding-right: 24px; }
          table  th:first-child, table td:first-child {
            padding-right: 0;
            width: 16px; }
          table th.numeric, table  td.numeric {
            text-align: right; }
        table tbody tr:hover {
          background-color: #EEEEEE; }

    </style>

  </template>

  <script>
    (function() {
      Polymer({
        is: 'tarq-table',

        properties: {
          _rows: {
            type: Array,
            value: [
              ['1','2','3'],
              ['1','2','3']
            ],
            notify: false
          },
          _columns: {
            type: Array,
            value: ['c1','c2','c3'],
            notify: false
          },
          _filters: {
            type: Object,
            value: {},
            notify: false
          },
          _sorts: {
            type: Object,
            value: {},
            notify: false
          }
        },

        // /table#sorts=column1,column2&filters=func1,func2,func3,func4&customSorts=sortFunc1,sortFunc2
        _applyHash: function(){
          var hashVals = this._getValuesFromHash(['sorts', 'filters']);

          console.log(hashVals);

          hashVals.sorts.forEach(function(sort){
            if(sort.indexOf('^') >= 0){
              this.orderOnColumn(sort.replace('^', ''), true);
            }else{
              this.orderOnColumn(sort);
            }
          }.bind(this));

          // todo: add checks to see if functions exists
          hashVals.filters.forEach(function(f){
            this.addFilter(f, window[f]);
          }.bind(this));

        },

        // events
        _theadClick: function(e)
        {
          // when we can remove sorts from ui this should add the column to the hash instead of replace sorts

          var column = e.model.column;

          if(this._sorts[column]){
            var rev = ( this._sorts[column].reverse ? '' : '^' );
            this._setValuesInHash({sorts: [e.model.column+rev]});
          }else{
            this._setValuesInHash({sorts: [e.model.column]});
          }

          this._applyHash();
        },

        // functions
        orderOnColumn: function(column, reverse){
          if (typeof reverse === 'undefined') { reverse = false; }


          // we delete the sorts from the other columns because we can't remove sorts in the ui
          for(var k in this._columns){
            if(this._columns[k] != column){
              if(this._sorts[this._columns[k]]){
                delete this._sorts[this._columns[k]];
              }
            }
          }

          this.addSort(column, {
            weight: 30,
            reverse: reverse,
            func: function(a, b){
              x = (parseInt(a[column]) ? parseInt(a[column]) : a[column]);
              y = (parseInt(b[column]) ? parseInt(b[column]) : b[column]);
              if(x < y)
                return -1;
              else
                return 1;
            }
          });
        },
        _filter: function(item)
        {
          if(Object.keys(this._filters).length > 0){
            return this._ifAll(item, this._filters);
          }else{
            return true;
          }
        },
        _sort: function(a, b)
        {
          if(Object.keys(this._sorts).length > 0){

            var sorts = Object.keys(this._sorts).map(function (key) {return this._sorts[key]}.bind(this)); // must be a better way to do this

            sorts.sort(function(a,b){
              return b.wheight - a.wheight;
            });

            var r = 0;
            for(i in sorts){
              r = sorts[i].func(a, b);
              if(sorts[i].reverse)
                r = r * -1;

              if(r != 0){
                break;
              }
            }

            return r;

          }else{
            return 0;
          }
        },
        // f = function(i)
        addFilter: function(name, f)
        {
          this._filters[name] = f;
          this.render();
        },
        removeFilter: function(name, f)
        {
          delete this._filters[name];
          this.render();
        },
        // s = { weight: 1, reverse: false, func: function(a)}
        addSort: function(name, s)
        {
          this._sorts[name] = s;
          this.render();
        },
        removeSort: function(name)
        {
          delete this._sorts[name];
          this.render();
        },
        render: function()
        {
          this.$.rows.render();
        },
        getRows: function()
        {
          return this._rows;
        },
        setRows: function(rows)
        {
          this.set('_rows', rows);
          this._applyHash();
        },
        getColumns: function(){
          return this._columns;
        },
        setColumns: function(columns){
          this.set('_columns', columns);
          this._applyHash();
        },


        // helpers
        // We need this helper function because polymer data binding does not support selecting a prop from a string
        _getColumnFrom: function(column, row)
        {
          return row[column];
        },
        _ifAny: function(x, fs)
        {
          for( f in fs){
            if(fs[f](x)){
              return true;
            }
          }
          return false;
        },
        _ifAll: function(x, fs)
        {
          for( f in fs){
            if(!fs[f](x)){
              return false
            }
          }
          return true;
        },
        _getValuesFromHash: function(vals){
          var hash = window.location.hash;
          var response = {};

          vals.forEach(function(val){
            response[val] = [];

            if(hash.indexOf(val+"=") >= 0){
              var s = hash.split(val+"=")[1];

              if(s.indexOf('&') >= 0){
                s = s.substr(0, s.indexOf('&')-1);
              }
              response[val] = s.split(',');
            }
          })

          return response;
        },
        _setValuesInHash: function(vals)
        {

          var hash = window.location.hash;

          for(var key in vals){

            var hashString = this._toHashString(key, vals[key]);

            if(hash.indexOf(key+'=') >= 0){
              var leftOf = hash.split(key+'=')[1];

              var end = ( leftOf.indexOf('&') >= 0 ? leftOf.indexOf('&') : leftOf.length );

              hash = hash.replace(
                key + '=' + leftOf.substr(0, end), // we need leftOf because we need to find the first & after val=
                hashString
              );
            }else{
              if(hash.length > 0){
                hash = hash + '&' + hashString;
              }else{
                hash = hashString;
              }
            }
          }

          window.location.hash = hash;

        },
        _toHashString: function(name, vals)
        {
          if(vals.length == 1){
            return name + "=" + vals[0];
          }else{
            return name + "=" + vals.shift() + ',' + vals.reduce(function(a, v){return a+','+v},'');
          }
        }

      });
    })();
  </script>
</dom-module>